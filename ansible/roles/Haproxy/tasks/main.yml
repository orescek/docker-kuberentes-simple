---
 - name: install haproxy
   package: 
    name: haproxy 
    state: present
   become: yes
   tags: haproxy   

 - name: get IP
   shell: echo $(kubectl get svc {{ app_name }} | grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}')
   register: run_app_ip
   become: yes
   tags: haproxy

 - name: "copy conf"
   template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
   become: yes
   tags: haproxy

 - name: Flush 
   command: iptables -F
   become: yes
   tags: haproxy

 - name: start haproxy
   service: 
    name: haproxy 
    state: restarted
   become: yes
   tags: haproxy 

